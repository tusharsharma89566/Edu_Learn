<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Adaptive Assessment - {{ user.first_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .question-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .timer-container {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        .progress-container {
            background: white;
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .option-btn {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            margin: 0.5rem 0;
            text-align: left;
            transition: all 0.3s;
            cursor: pointer;
        }
        .option-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }
        .option-btn.selected {
            border-color: #667eea;
            background: #e3f2fd;
        }
        .feedback-container {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .difficulty-indicator {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .difficulty-easy { background: #d4edda; color: #155724; }
        .difficulty-medium { background: #fff3cd; color: #856404; }
        .difficulty-hard { background: #f8d7da; color: #721c24; }
        .difficulty-expert { background: #cce5ff; color: #004085; }
        
        .loading-spinner {
            display: none;
        }
        
        .assessment-complete {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 15px;
            padding: 3rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-brain me-2"></i>Adaptive Assessment
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('adaptive.dashboard') }}">
                    <i class="fas fa-chart-line me-1"></i>Dashboard
                </a>
                <a class="nav-link" href="{{ url_for('student_dashboard') }}">
                    <i class="fas fa-home me-1"></i>Home
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Assessment Setup -->
        <div id="assessmentSetup" class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-cog text-primary me-2"></i>Assessment Setup
                        </h4>
                    </div>
                    <div class="card-body">
                        <form id="assessmentForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="assessmentTitle" class="form-label">Assessment Title</label>
                                        <input type="text" class="form-control" id="assessmentTitle" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="courseSelect" class="form-label">Course</label>
                                        <select class="form-select" id="courseSelect" required>
                                            <option value="">Select a course</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="maxQuestions" class="form-label">Number of Questions</label>
                                        <select class="form-select" id="maxQuestions">
                                            <option value="10">10 Questions</option>
                                            <option value="20" selected>20 Questions</option>
                                            <option value="30">30 Questions</option>
                                            <option value="50">50 Questions</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="timeLimit" class="form-label">Time Limit (minutes)</label>
                                        <select class="form-select" id="timeLimit">
                                            <option value="15">15 minutes</option>
                                            <option value="30" selected>30 minutes</option>
                                            <option value="45">45 minutes</option>
                                            <option value="60">60 minutes</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="initialDifficulty" class="form-label">Starting Difficulty</label>
                                        <select class="form-select" id="initialDifficulty">
                                            <option value="0.3">Beginner</option>
                                            <option value="0.5" selected>Intermediate</option>
                                            <option value="0.7">Advanced</option>
                                            <option value="0.9">Expert</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="assessmentDescription" class="form-label">Description (Optional)</label>
                                <textarea class="form-control" id="assessmentDescription" rows="3"></textarea>
                            </div>
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-play me-2"></i>Start Assessment
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assessment Interface -->
        <div id="assessmentInterface" style="display: none;">
            <!-- Timer and Progress -->
            <div class="row mb-3">
                <div class="col-md-8">
                    <div class="progress-container">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">Progress</span>
                            <span id="progressText">0 / 0</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="timer-container">
                        <i class="fas fa-clock me-2"></i>
                        <span id="timer">00:00</span>
                    </div>
                </div>
            </div>

            <!-- Question Display -->
            <div id="questionDisplay">
                <div class="question-container">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h4 id="questionText">Loading question...</h4>
                        <span class="difficulty-indicator" id="difficultyIndicator">Medium</span>
                    </div>
                    
                    <div id="questionOptions">
                        <p class="text-muted">Loading options...</p>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-light btn-lg" id="submitAnswer" disabled>
                            <i class="fas fa-check me-2"></i>Submit Answer
                        </button>
                        <button class="btn btn-outline-light btn-lg ms-2" id="skipQuestion">
                            <i class="fas fa-forward me-2"></i>Skip
                        </button>
                    </div>
                </div>
            </div>

            <!-- Feedback Display -->
            <div id="feedbackDisplay" style="display: none;">
                <div class="feedback-container">
                    <div id="feedbackContent">
                        <!-- Feedback content will be loaded here -->
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-primary btn-lg" id="nextQuestion">
                            <i class="fas fa-arrow-right me-2"></i>Next Question
                        </button>
                    </div>
                </div>
            </div>

            <!-- Assessment Complete -->
            <div id="assessmentComplete" style="display: none;">
                <div class="assessment-complete">
                    <i class="fas fa-trophy fa-4x mb-3"></i>
                    <h2>Assessment Complete!</h2>
                    <p class="lead">Great job! You've completed the adaptive assessment.</p>
                    <div id="finalResults">
                        <!-- Final results will be loaded here -->
                    </div>
                    <div class="mt-4">
                        <a href="{{ url_for('adaptive.dashboard') }}" class="btn btn-light btn-lg me-3">
                            <i class="fas fa-chart-line me-2"></i>View Dashboard
                        </a>
                        <a href="{{ url_for('adaptive.results_page') }}" class="btn btn-outline-light btn-lg">
                            <i class="fas fa-chart-bar me-2"></i>Detailed Results
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading assessment...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentAssessment = null;
        let currentQuestion = null;
        let selectedAnswer = null;
        let timer = null;
        let timeRemaining = 0;
        let questionStartTime = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadCourses();
            setupEventListeners();
        });

        // Load available courses
        async function loadCourses() {
            try {
                const response = await fetch('/content/courses');
                const data = await response.json();
                
                if (data.success) {
                    const courseSelect = document.getElementById('courseSelect');
                    data.courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.title;
                        courseSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Assessment form submission
            document.getElementById('assessmentForm').addEventListener('submit', startAssessment);
            
            // Answer submission
            document.getElementById('submitAnswer').addEventListener('click', submitAnswer);
            document.getElementById('skipQuestion').addEventListener('click', skipQuestion);
            document.getElementById('nextQuestion').addEventListener('click', loadNextQuestion);
        }

        // Start assessment
        async function startAssessment(event) {
            event.preventDefault();
            
            const formData = {
                title: document.getElementById('assessmentTitle').value,
                course_id: parseInt(document.getElementById('courseSelect').value),
                max_questions: parseInt(document.getElementById('maxQuestions').value),
                time_limit_minutes: parseInt(document.getElementById('timeLimit').value),
                initial_difficulty: parseFloat(document.getElementById('initialDifficulty').value),
                description: document.getElementById('assessmentDescription').value
            };
            
            try {
                showLoading(true);
                
                // Create assessment
                const createResponse = await fetch('/adaptive/assessments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const createData = await createResponse.json();
                
                if (createData.success) {
                    currentAssessment = createData.assessment;
                    
                    // Start assessment
                    const startResponse = await fetch(`/adaptive/assessments/${currentAssessment.id}/start`, {
                        method: 'POST'
                    });
                    
                    const startData = await startResponse.json();
                    
                    if (startData.success) {
                        currentQuestion = startData.question;
                        showAssessmentInterface();
                        displayQuestion();
                        startTimer();
                    } else {
                        alert('Error starting assessment: ' + startData.message);
                    }
                } else {
                    alert('Error creating assessment: ' + createData.message);
                }
            } catch (error) {
                console.error('Error starting assessment:', error);
                alert('Error starting assessment. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Show assessment interface
        function showAssessmentInterface() {
            document.getElementById('assessmentSetup').style.display = 'none';
            document.getElementById('assessmentInterface').style.display = 'block';
        }

        // Display current question
        function displayQuestion() {
            if (!currentQuestion) return;
            
            document.getElementById('questionText').textContent = currentQuestion.question_text;
            document.getElementById('difficultyIndicator').textContent = currentQuestion.difficulty_level.charAt(0).toUpperCase() + currentQuestion.difficulty_level.slice(1);
            document.getElementById('difficultyIndicator').className = `difficulty-indicator difficulty-${currentQuestion.difficulty_level}`;
            
            // Display options based on question type
            const optionsContainer = document.getElementById('questionOptions');
            
            if (currentQuestion.question_type === 'multiple_choice') {
                displayMultipleChoiceOptions(currentQuestion.options, optionsContainer);
            } else if (currentQuestion.question_type === 'true_false') {
                displayTrueFalseOptions(optionsContainer);
            } else {
                displayTextInput(optionsContainer);
            }
            
            // Reset selection
            selectedAnswer = null;
            document.getElementById('submitAnswer').disabled = true;
            
            // Record question start time
            questionStartTime = Date.now();
            
            // Show question display
            document.getElementById('questionDisplay').style.display = 'block';
            document.getElementById('feedbackDisplay').style.display = 'none';
        }

        // Display multiple choice options
        function displayMultipleChoiceOptions(options, container) {
            let html = '';
            options.forEach((option, index) => {
                html += `
                    <button class="option-btn w-100" data-option="${option}" onclick="selectOption(this, '${option}')">
                        <strong>${String.fromCharCode(65 + index)}.</strong> ${option}
                    </button>
                `;
            });
            container.innerHTML = html;
        }

        // Display true/false options
        function displayTrueFalseOptions(container) {
            container.innerHTML = `
                <button class="option-btn w-100" data-option="true" onclick="selectOption(this, 'true')">
                    <strong>A.</strong> True
                </button>
                <button class="option-btn w-100" data-option="false" onclick="selectOption(this, 'false')">
                    <strong>B.</strong> False
                </button>
            `;
        }

        // Display text input
        function displayTextInput(container) {
            container.innerHTML = `
                <div class="mb-3">
                    <label for="textAnswer" class="form-label">Your Answer:</label>
                    <textarea class="form-control" id="textAnswer" rows="3" placeholder="Enter your answer here..."></textarea>
                </div>
            `;
            
            // Add event listener for text input
            document.getElementById('textAnswer').addEventListener('input', function() {
                selectedAnswer = this.value.trim();
                document.getElementById('submitAnswer').disabled = !selectedAnswer;
            });
        }

        // Select option
        function selectOption(element, option) {
            // Remove previous selection
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Select new option
            element.classList.add('selected');
            selectedAnswer = option;
            document.getElementById('submitAnswer').disabled = false;
        }

        // Submit answer
        async function submitAnswer() {
            if (!selectedAnswer) return;
            
            try {
                const responseTime = questionStartTime ? (Date.now() - questionStartTime) / 1000 : 0;
                
                const response = await fetch(`/adaptive/assessments/${currentAssessment.id}/answer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question_id: currentQuestion.id,
                        user_answer: selectedAnswer,
                        response_time: responseTime
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.assessment_complete) {
                        showAssessmentComplete(data.assessment);
                    } else {
                        showFeedback(data.feedback);
                        updateProgress();
                    }
                } else {
                    alert('Error submitting answer: ' + data.message);
                }
            } catch (error) {
                console.error('Error submitting answer:', error);
                alert('Error submitting answer. Please try again.');
            }
        }

        // Skip question
        async function skipQuestion() {
            selectedAnswer = 'skip';
            await submitAnswer();
        }

        // Show feedback
        function showFeedback(feedback) {
            const feedbackContent = document.getElementById('feedbackContent');
            const isCorrect = feedback.is_correct;
            
            feedbackContent.innerHTML = `
                <div class="text-center mb-3">
                    <i class="fas fa-${isCorrect ? 'check-circle text-success' : 'times-circle text-danger'} fa-3x"></i>
                </div>
                <h5 class="text-center mb-3">${isCorrect ? 'Correct!' : 'Incorrect'}</h5>
                ${feedback.explanation ? `
                    <div class="alert alert-info">
                        <strong>Explanation:</strong> ${feedback.explanation}
                    </div>
                ` : ''}
                ${feedback.suggestions.length > 0 ? `
                    <div class="alert alert-warning">
                        <strong>Suggestions:</strong>
                        <ul class="mb-0 mt-2">
                            ${feedback.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('questionDisplay').style.display = 'none';
            document.getElementById('feedbackDisplay').style.display = 'block';
        }

        // Load next question
        async function loadNextQuestion() {
            try {
                const response = await fetch(`/adaptive/assessments/${currentAssessment.id}/question`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.assessment_complete) {
                        showAssessmentComplete(data.assessment);
                    } else {
                        currentQuestion = data.question;
                        displayQuestion();
                        updateProgress();
                    }
                } else {
                    alert('Error loading next question: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading next question:', error);
                alert('Error loading next question. Please try again.');
            }
        }

        // Show assessment complete
        function showAssessmentComplete(assessment) {
            stopTimer();
            
            const finalResults = document.getElementById('finalResults');
            finalResults.innerHTML = `
                <div class="row text-center">
                    <div class="col-md-4">
                        <h4>${Math.round(assessment.final_score)}%</h4>
                        <p>Final Score</p>
                    </div>
                    <div class="col-md-4">
                        <h4>${assessment.questions_answered}</h4>
                        <p>Questions Answered</p>
                    </div>
                    <div class="col-md-4">
                        <h4>${assessment.proficiency_level}</h4>
                        <p>Proficiency Level</p>
                    </div>
                </div>
            `;
            
            document.getElementById('assessmentInterface').style.display = 'none';
            document.getElementById('assessmentComplete').style.display = 'block';
            
            // Update analytics
            updateAnalytics(assessment.id);
        }

        // Start timer
        function startTimer() {
            timeRemaining = currentAssessment.time_limit_minutes * 60;
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    stopTimer();
                    alert('Time is up! Assessment will be submitted automatically.');
                    // Auto-submit assessment
                }
            }, 1000);
        }

        // Stop timer
        function stopTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Update progress
        function updateProgress() {
            const progress = currentAssessment.get_progress_percentage();
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                `${currentAssessment.questions_answered} / ${currentAssessment.max_questions}`;
        }

        // Update analytics
        async function updateAnalytics(assessmentId) {
            try {
                await fetch('/adaptive/analytics/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        assessment_id: assessmentId
                    })
                });
            } catch (error) {
                console.error('Error updating analytics:', error);
            }
        }

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html> 